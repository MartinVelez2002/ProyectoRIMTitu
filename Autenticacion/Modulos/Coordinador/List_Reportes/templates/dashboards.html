{% extends 'modulos.html' %}

{% block title %}
Resumen de datos
{% endblock %}

{% block forms %}
    <div style="width: 30%; margin: auto; padding: 20px;">
        <!-- Gráfico de Prioridades -->
        <canvas id="prioridadChart"></canvas>
    </div>

    <div style="width: 30%; margin: auto; padding: 20px;">
        <!-- Gráfico de Tendencia -->
        <canvas id="tendenciaChart"></canvas>
    </div>
{% endblock %}

{% block js %}
    <script>
        // Gráfico de Prioridades (Pie Chart)
        var ctx = document.getElementById('prioridadChart').getContext('2d');
        var prioridadChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Alto', 'Medio', 'Bajo'], // Etiquetas completas
                datasets: [{
                    label: 'Prioridades',
                    data: {{ data|safe }}, // Datos dinámicos desde Django
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.4)',  // Rojo tenue
                        'rgba(255, 206, 86, 0.4)',  // Amarillo tenue
                        'rgba(75, 192, 192, 0.4)'   // Verde tenue
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',  // Rojo
                        'rgba(255, 206, 86, 1)',  // Amarillo
                        'rgba(75, 192, 192, 1)'   // Verde
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top', // Muestra etiquetas completas arriba
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let value = context.raw;
                                let percentage = ((value / total) * 100).toFixed(2);
                                return `${context.label}: ${value} (${percentage}%)`; // Etiqueta completa y datos
                            }
                        }
                    }
                }
            }
        });

        // Gráfico de Tendencia de Incidencias (Line Chart)
        var ctx2 = document.getElementById('tendenciaChart').getContext('2d');
        var tendenciaChart = new Chart(ctx2, {
            type: 'line',
            data: {
                labels: {{ fechas|safe }}, // Fechas dinámicas desde Django
                datasets: [
                    {% for estado in tendencia_data %}
                    {
                        label: '{{ estado.label }}',  // Nombre del estado (e.g., Notificado, En Proceso, etc.)
                        data: {{ estado.data|safe }}, // Datos dinámicos desde Django
                        fill: false,
                        borderColor: getColor('{{ estado.label }}'),  // Función para asignar color según el estado
                        tension: 0.1
                    },
                    {% endfor %}
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return `Incidencias: ${tooltipItem.raw}`;
                            }
                        }
                    },
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Mes'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Cantidad de Incidencias'
                        },
                        beginAtZero: true
                    }
                }
            }
        });

        // Función para asignar color según el estado
        function getColor(estado) {
            switch (estado) {
                case 'Notificado':
                    return 'rgba(75, 192, 192, 1)'; // Verde claro
                case 'En Proceso':
                    return 'rgba(255, 159, 64, 1)'; // Naranja
                case 'Atendido':
                    return 'rgba(255, 99, 132, 1)'; // Rojo
                case 'Cerrado':
                    return 'rgba(54, 162, 235, 1)'; // Azul
                default:
                    return 'rgba(0, 0, 0, 1)'; // Negro (por defecto)
            }
        }
    </script>
{% endblock %}
