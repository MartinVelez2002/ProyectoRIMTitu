{% extends 'modulos.html '%}

{% load static %}
{% load custom_filters %}

{% block title %}
Módulo Reportes
{% endblock %}

{% block thead %}
<th> Id </th>
<th> Fecha </th>
<th> Hora </th>
<th> Turno </th>
<th> Lugar </th>
<th> Reporta </th>
<th> Novedad </th>
<th> Prioridad </th>
<th> Estado Incidente </th>
<th> Ver evidencia y descripción </th>

{% endblock %}

{% block tbody %}
{% if rep %}
{% for cab in rep %}
<tr>
    <td> {{ cab.id }} </td>
    <td>{{ cab.fecha }}</td>
    <td>
        {# Mostramos la hora del primer detalle como ejemplo, pero puedes personalizar según tu lógica #}
        {{ cab.detalles.first.hora|default:"-" }}
    </td>
    <td> {{ cab.agente.turno|default:"-" }} </td>
    <td> {{ cab.agente.ubicacion|default:"-" }} </td>
    <td> {{ cab.agente.usuario.nombre|default:"-" }} {{ cab.agente.usuario.apellido|default:"-" }}</td>
    <td>{{ cab.novedad }}</td>
    <td>
        <span class="btn {% if cab.prioridad == 'M' %}btn-warning{% elif cab.prioridad == 'A' %}btn-danger{% else %}btn-success{% endif %}">
            {{ cab.get_prioridad_display }}
        </span>
    </td>
    <td>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="incidente_id" value="{{ cab.id }}">
            
            <div class="form-group">
                <label for="nuevo_estado">Nuevo Estado</label>
                <select class="form-control" name="nuevo_estado" id="nuevo_estado" required>
                    <option value="N" {% if nuevo_estado == 'N' or cab.estado_incidente == 'N' %}selected{% endif %}>Notificado</option>
                    <option value="E" {% if nuevo_estado == 'E' or cab.estado_incidente == 'E' %}selected{% endif %}>En Proceso</option>
                    <option value="A" {% if nuevo_estado == 'A' or cab.estado_incidente == 'A' %}selected{% endif %}>Atendido</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="descripcion">Descripción</label>
                <textarea class="form-control" name="descripcion" id="descripcion" required></textarea>
            </div>
        
            <div class="form-group">
                <label for="evidencia">Evidencia (opcional)</label>
                <input type="file" class="form-control" name="evidencia" id="evidencia">
            </div>
        
            <button type="submit" class="btn btn-primary">Actualizar Estado</button>
        </form>
    </td>
    <td>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalLabel-{{ cab.id }}">
            <i class="fa-sharp fa-solid fa-eye"></i>
        </button>
    </td>
    </td>
    <td>
        <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalLabel-{{ cab.id }}">
            <i class="fa-sharp fa-solid fa-eye"></i>
        </button>
        
    </td>
    
</tr>

<!-- Modal para detalles -->
<div class="modal fade" id="modalLabel-{{ cab.id }}" tabindex="-1" aria-labelledby="modalLabel-{{ cab.id }}"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark">
                <h1 class="modal-title text-white fs-5 mx-auto" id="modalLabel-{{ cab.id }}">Visualización del reporte
                    <strong>
                        || Novedad: </strong>{{cab.novedad}} || <strong> Fecha: </strong> {{ cab.fecha }} </h1>
            </div>
            <div class="modal-body flex">
                {% for det in cab.detalles.all %}
                <div class="d-flex flex-column">
                    {% if det.evidencia %}
                    {% if det.evidencia.url|is_image %}
                    <img width="500px" class="mx-auto my-auto" src="{{ det.evidencia.url }}" alt="Evidencia"
                        class="img-fluid">
                    {% elif det.evidencia.url|is_video %}
                    <video width="400px" class="mx-auto my-auto" src="{{ det.evidencia.url }}" controls
                        class="img-fluid"></video>
                    {% endif %}
                    {% else %}
                    <p>No hay evidencia disponible.</p>
                    {% endif %}
                    <div class="d-flex flex-row justify-content-evenly">
                        <p><strong>Hora:</strong> {{ det.hora }}</p>
                        <p><strong>Prioridad:</strong> {{ det.get_prioridad_display }}</p>
                        <p> <strong>Descripción: </strong> {{det.descripcion}} </p>
                    </div>

                </div>
                {% endfor %}
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<tr>
    <td colspan="10">Aún no se han realizado reportes</td>
</tr>
{% endif %}

{% endblock %}